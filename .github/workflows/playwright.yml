name: Playwright Tests

on:
    push:
        branches: [main, master]
    pull_request:
        branches: [main, master]

permissions:
    contents: read
    pages: write
    id-token: write

concurrency:
    group: github-pages
    cancel-in-progress: true

jobs:
    test:
        timeout-minutes: 60
        runs-on: ubuntu-latest
        env:
            TEST_ENV: qa
            SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL || '' }}
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: lts/*
            - name: Install dependencies
              run: npm ci
            - name: Install Playwright Browsers
              run: npx playwright install chromium
            - name: Run Playwright tests
              run: npx playwright test --project=chromium
            - uses: actions/upload-artifact@v4
              if: ${{ !cancelled() }}
              with:
                  name: playwright-report
                  path: playwright-report/
                  retention-days: 30
            - name: Setup Pages
              if: ${{ github.event_name == 'push' && !cancelled() }}
              uses: actions/configure-pages@v5
              with:
                  enablement: true
            - name: Upload Pages artifact
              if: ${{ github.event_name == 'push' && !cancelled() }}
              uses: actions/upload-pages-artifact@v3
              with:
                  path: playwright-report
            - name: Notify Slack
              if: ${{ always() && env.SLACK_WEBHOOK_URL != '' }}
              env:
                  JOB_STATUS: ${{ job.status }}
                  RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
                  BRANCH: ${{ github.ref_name }}
                  REPO: ${{ github.repository }}
                  ACTOR: ${{ github.actor }}
                  PAGES_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
              run: |
                  payload=$(jq -n \
                    --arg status "$JOB_STATUS" \
                    --arg repo "$REPO" \
                    --arg branch "$BRANCH" \
                    --arg actor "$ACTOR" \
                    --arg url "$RUN_URL" \
                    --arg pages "$PAGES_URL" \
                    '{
                      text: "[Playwright] Estado: \($status)",
                      blocks: [
                        {
                          type: "section",
                          text: {
                            type: "mrkdwn",
                            text: "*Playwright CI \($status)*\nRepositorio: `\($repo)`\nRama: `\($branch)`\nDisparado por: `\($actor)`\n<\($url)|Ver ejecuciÃ³n en GitHub>\n<\($pages)|Ver reporte en GitHub Pages>"
                          }
                        }
                      ]
                    }')
                  curl -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"

    deploy:
        if: ${{ github.event_name == 'push' }}
        needs: test
        runs-on: ubuntu-latest
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        steps:
            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4
